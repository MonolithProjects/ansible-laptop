---
- name: System tuning
  hosts: laptop
  become: yes
  gather_facts: yes
  tasks:
  - name: CLI history backward
    lineinfile:
      path: /etc/inputrc
      regexp: ' history-search-backward$'
      line: '"\e[A": history-search-backward'

  - name: CLI history forward
    lineinfile:
      path: /etc/inputrc
      regexp: ' history-search-forward'
      line: '"\e[B": history-search-forward'

  - name: Copy aliases file
    template:
      src: ../templates/aliases
      dest: ~/.alias
      mode: 0600
    become: no
  
  - name: Add aliases to zsh
    lineinfile:
      path: ~/.zshrc
      regexp: '.alias$'
      line: source $HOME/.alias
    become: no

  - name: Add path to zsh
    lineinfile:
      path: ~/.zshrc
      regexp: '^export PATH='
      line: export PATH=$PATH:$HOME/.local/bin
    become: no

  - name: Copy openvpn-dt script file
    template:
      src: ../templates/openvpn-dt
      dest: /usr/bin/openvpn-dt
      mode: 0755

  - name: Create /etc/openvpn/scripts/
    file:
      path: /etc/openvpn/scripts
      state: directory
      recurse: yes

  - name: Copy update-systemd-resolved
    copy:
      src: ../files/update-systemd-resolved
      dest: /etc/openvpn/scripts/update-systemd-resolved
      mode: 0755

  - name: Copy resolv conf pannet
    copy:
      src: ../files/resolv.conf.pannet
      dest: /etc/resolv.conf.pannet
      mode: 0644
  
  - name: Link to /run/systemd/resolve/resolv.conf
    file:
      src: /run/systemd/resolve/resolv.conf
      dest: /etc/resolv.conf
      state: link
      force: yes

  - name: Enable and start systemd-resolved
    systemd:
      name: systemd-resolved
      enabled: yes
      state: started

  - name: Eanble and start docker
    systemd:
      name: docker
      enabled: yes
      state: started

  - name: Create a volume portainer_data
    docker_volume:
      name: portainer_data

  - name: portainer
    docker_container:
      name: portainer
      image: portainer:latest
      pull: yes
      state: started
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - portainer_data:/data
      env:
        TZ: "CET"
      